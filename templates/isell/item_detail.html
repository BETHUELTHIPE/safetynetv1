{% extends 'base.html' %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-4" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
    
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'isell:item_list' %}">I Sell</a></li>
            <li class="breadcrumb-item">{{ item.category }}</li>
            <li class="breadcrumb-item active" aria-current="page">{{ item.title }}</li>
        </ol>
    </nav>
    
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Item Images Carousel -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-0">
                    {% if item.main_image or item.additional_image1 or item.additional_image2 %}
                        <div id="itemCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-indicators">
                                {% if item.main_image %}
                                    <button type="button" data-bs-target="#itemCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Main Image"></button>
                                {% endif %}
                                {% if item.additional_image1 %}
                                    <button type="button" data-bs-target="#itemCarousel" data-bs-slide-to="1" aria-label="Additional Image 1"></button>
                                {% endif %}
                                {% if item.additional_image2 %}
                                    <button type="button" data-bs-target="#itemCarousel" data-bs-slide-to="2" aria-label="Additional Image 2"></button>
                                {% endif %}
                            </div>
                            <div class="carousel-inner">
                                {% if item.main_image %}
                                    <div class="carousel-item active">
                                        <img src="{{ item.main_image.url }}" class="d-block w-100 item-detail-image" alt="{{ item.title }}">
                                    </div>
                                {% endif %}
                                {% if item.additional_image1 %}
                                    <div class="carousel-item">
                                        <img src="{{ item.additional_image1.url }}" class="d-block w-100 item-detail-image" alt="{{ item.title }}">
                                    </div>
                                {% endif %}
                                {% if item.additional_image2 %}
                                    <div class="carousel-item">
                                        <img src="{{ item.additional_image2.url }}" class="d-block w-100 item-detail-image" alt="{{ item.title }}">
                                    </div>
                                {% endif %}
                            </div>
                            
                            {% if item.additional_image1 or item.additional_image2 %}
                                <button class="carousel-control-prev" type="button" data-bs-target="#itemCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Previous</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#itemCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Next</span>
                                </button>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="no-image-placeholder p-5 text-center">
                            <i class="fas fa-image fa-4x mb-3 text-muted"></i>
                            <h5 class="text-muted">No images available</h5>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Item Details Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge bg-{{ item.status|lower }}">{{ item.get_status_display }}</span>
                        {% if item.is_new %}
                            <span class="badge bg-success ms-2">NEW</span>
                        {% endif %}
                    </div>
                    <small class="text-muted">
                        <i class="far fa-eye me-1"></i> {{ item.view_count }} views
                    </small>
                </div>
                
                <div class="card-body">
                    <h1 class="card-title mb-2">{{ item.title }}</h1>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="price-display">
                            <span class="price-tag">R{{ item.price }}</span>
                            {% if item.negotiable %}
                                <span class="badge bg-light text-dark ms-2">Negotiable</span>
                            {% endif %}
                        </div>
                        <div class="text-muted small">
                            Posted {{ item.created_at|timesince }} ago
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- Location -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-map-marker-alt text-primary me-2"></i>
                            <h5 class="mb-0">Location</h5>
                        </div>
                        <p class="ms-4 mb-0">{{ item.location }}</p>
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-align-left text-primary me-2"></i>
                            <h5 class="mb-0">Description</h5>
                        </div>
                        <div class="ms-4 item-description">
                            {{ item.description|linebreaks }}
                        </div>
                    </div>
                    
                    <!-- Category and Tags -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-tag text-primary me-2"></i>
                            <h5 class="mb-0">Category & Tags</h5>
                        </div>
                        <div class="ms-4">
                            <div class="mb-2">
                                <span class="badge bg-primary">{{ item.category }}</span>
                            </div>
                            
                            {% if item.tags %}
                                <div class="tag-list">
                                    {% for tag in item.tags.split|slice:":10" %}
                                        <span class="badge bg-light text-dark me-1">{{ tag }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Additional Files -->
                    {% if item.pdf_document or item.video %}
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-paperclip text-primary me-2"></i>
                                <h5 class="mb-0">Additional Files</h5>
                            </div>
                            <div class="ms-4">
                                <div class="list-group">
                                    {% if item.pdf_document %}
                                        <a href="{{ item.pdf_document.url }}" target="_blank" class="list-group-item list-group-item-action d-flex align-items-center">
                                            <i class="fas fa-file-pdf text-danger me-3 fa-lg"></i>
                                            <div>
                                                <strong>PDF Document</strong><br>
                                                <span class="text-muted small">Click to view or download</span>
                                            </div>
                                        </a>
                                    {% endif %}
                                    
                                    {% if item.video %}
                                        <a href="{{ item.video.url }}" target="_blank" class="list-group-item list-group-item-action d-flex align-items-center">
                                            <i class="fas fa-file-video text-primary me-3 fa-lg"></i>
                                            <div>
                                                <strong>Video</strong><br>
                                                <span class="text-muted small">Click to view or download</span>
                                            </div>
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Action Buttons -->
                <div class="card-footer bg-white py-3">
                    <div class="d-flex justify-content-between">
                        <div>
                            {% if user.is_authenticated %}
                                {% if item.status == 'ACTIVE' and item.seller != user %}
                                    <a href="{% url 'isell:send_message' pk=item.pk %}" class="btn btn-primary">
                                        <i class="fas fa-comment me-1"></i> Contact Seller
                                    </a>
                                    
                                    {% if is_saved %}
                                        <button id="saveButton" class="btn btn-outline-warning" data-id="{{ item.pk }}">
                                            <i class="fas fa-bookmark me-1"></i> Saved
                                        </button>
                                    {% else %}
                                        <button id="saveButton" class="btn btn-outline-secondary" data-id="{{ item.pk }}">
                                            <i class="far fa-bookmark me-1"></i> Save Item
                                        </button>
                                    {% endif %}
                                {% endif %}
                                
                                {% if item.seller == user %}
                                    <div class="btn-group">
                                        <a href="{% url 'isell:edit_item' pk=item.pk %}" class="btn btn-outline-primary">
                                            <i class="fas fa-edit me-1"></i> Edit
                                        </a>
                                        <a href="{% url 'isell:delete_item' pk=item.pk %}" class="btn btn-outline-danger">
                                            <i class="fas fa-trash me-1"></i> Delete
                                        </a>
                                        
                                        {% if item.status == 'ACTIVE' %}
                                            <a href="{% url 'isell:mark_as_sold' pk=item.pk %}" class="btn btn-success">
                                                <i class="fas fa-check-circle me-1"></i> Mark as Sold
                                            </a>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% else %}
                                <a href="{% url 'login' %}?next={% url 'isell:item_detail' pk=item.pk %}" class="btn btn-primary">
                                    <i class="fas fa-sign-in-alt me-1"></i> Login to Contact Seller
                                </a>
                            {% endif %}
                        </div>
                        
                        <a href="{% url 'isell:item_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i> Back to Listings
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Seller Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i> Seller Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        {% if item.seller.profile.profile_image %}
                            <img src="{{ item.seller.profile.profile_image.url }}" alt="{{ item.seller.username }}" class="rounded-circle me-3" style="width: 60px; height: 60px; object-fit: cover;">
                        {% else %}
                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
                                {{ item.seller.username|make_list|first|upper }}
                            </div>
                        {% endif %}
                        <div>
                            <h5 class="mb-0">{{ item.seller.get_full_name|default:item.seller.username }}</h5>
                            <p class="text-muted small mb-0">Member since {{ item.seller.date_joined|date:"F Y" }}</p>
                        </div>
                    </div>
                    
                    <hr>
                    
                    {% if item.status == 'ACTIVE' %}
                        <h6 class="mb-3">Contact Options</h6>
                        
                        <!-- Contact Buttons -->
                        {% if item.contact_number %}
                            <a href="tel:{{ item.contact_number }}" class="btn btn-outline-primary d-block mb-2">
                                <i class="fas fa-phone-alt me-2"></i> {{ item.contact_number }}
                            </a>
                        {% endif %}
                        
                        {% if item.whatsapp_number %}
                            <a href="https://wa.me/{{ item.whatsapp_number|slice:'1:' }}" target="_blank" class="btn btn-success d-block mb-2">
                                <i class="fab fa-whatsapp me-2"></i> Chat on WhatsApp
                            </a>
                        {% endif %}
                        
                        {% if item.show_email %}
                            <a href="mailto:{{ item.seller.email }}" class="btn btn-outline-secondary d-block mb-2">
                                <i class="fas fa-envelope me-2"></i> {{ item.seller.email }}
                            </a>
                        {% endif %}
                        
                        {% if user.is_authenticated and user != item.seller %}
                            <a href="{% url 'isell:send_message' pk=item.pk %}" class="btn btn-primary d-block">
                                <i class="fas fa-comment me-2"></i> Send Message
                            </a>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-exclamation-circle me-2"></i> This item is no longer available.
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Safety Tips Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i> Safety Tips
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2 d-flex">
                            <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                            <span>Meet in public places during daylight hours</span>
                        </li>
                        <li class="mb-2 d-flex">
                            <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                            <span>Inspect items thoroughly before purchase</span>
                        </li>
                        <li class="mb-2 d-flex">
                            <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                            <span>Be cautious with high-value transactions</span>
                        </li>
                        <li class="mb-0 d-flex">
                            <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                            <span>Report suspicious activities to the Community Police Forum</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Report Item Card -->
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <button class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-flag me-1"></i> Report this listing
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .item-detail-image {
        height: 500px;
        object-fit: contain;
        background-color: #f8f9fa;
    }
    
    .price-tag {
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--kingsapark-green);
    }
    
    .item-description {
        white-space: pre-line;
    }
    
    .bg-active { background-color: #28a745; }
    .bg-sold { background-color: #6c757d; }
    .bg-expired { background-color: #dc3545; }
    .bg-removed { background-color: #6c757d; }
</style>

{% if user.is_authenticated %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Save/unsave functionality
        const saveButton = document.getElementById('saveButton');
        
        if (saveButton) {
            saveButton.addEventListener('click', function(event) {
                event.preventDefault();
                
                const itemId = this.dataset.id;
                
                // Send AJAX request to toggle save status
                fetch(`/isell/${itemId}/save/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.saved) {
                        saveButton.innerHTML = '<i class="fas fa-bookmark me-1"></i> Saved';
                        saveButton.classList.remove('btn-outline-secondary');
                        saveButton.classList.add('btn-outline-warning');
                    } else {
                        saveButton.innerHTML = '<i class="far fa-bookmark me-1"></i> Save Item';
                        saveButton.classList.remove('btn-outline-warning');
                        saveButton.classList.add('btn-outline-secondary');
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        }
    });
</script>
{% endif %}
{% endblock %}
