{% extends 'base.html' %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'community_alerts:alert_list' %}">Community Alerts</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ title }}</li>
        </ol>
    </nav>
    
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card border-0 shadow">
                <div class="card-header bg-primary text-white py-3">
                    <h2 class="h4 mb-0">{{ title }}</h2>
                </div>
                
                <div class="card-body p-4">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <div class="row g-3">
                            <!-- Alert Content Section -->
                            <div class="col-12 mb-4">
                                <h5 class="border-bottom pb-2 mb-3">Alert Content</h5>
                                
                                <div class="mb-3">
                                    <label for="{{ form.title.id_for_label }}" class="form-label">Title*</label>
                                    {{ form.title }}
                                    {% if form.title.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.title.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">A clear, concise title for the alert.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.content.id_for_label }}" class="form-label">Content*</label>
                                    {{ form.content }}
                                    {% if form.content.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.content.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">Provide detailed information about the alert. Include relevant details that community members need to know.</div>
                                </div>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.category.id_for_label }}" class="form-label">Category*</label>
                                        {{ form.category }}
                                        {% if form.category.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.category.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.severity.id_for_label }}" class="form-label">Severity*</label>
                                        {{ form.severity }}
                                        {% if form.severity.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.severity.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">{{ form.severity.help_text }}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Targeting Section -->
                            <div class="col-12 mb-4">
                                <h5 class="border-bottom pb-2 mb-3">Alert Targeting</h5>
                                
                                <div class="mb-3">
                                    <label for="{{ form.location.id_for_label }}" class="form-label">Location Description</label>
                                    {{ form.location }}
                                    {% if form.location.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.location.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">Describe the location relevant to this alert (e.g., "Kings Park Shopping Center").</div>
                                </div>
                                
                                <div class="row g-3">
                                    <div class="col-md-5">
                                        <label for="{{ form.latitude.id_for_label }}" class="form-label">Latitude</label>
                                        {{ form.latitude }}
                                        {% if form.latitude.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.latitude.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-5">
                                        <label for="{{ form.longitude.id_for_label }}" class="form-label">Longitude</label>
                                        {{ form.longitude }}
                                        {% if form.longitude.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.longitude.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-2">
                                        <label for="{{ form.radius.id_for_label }}" class="form-label">Radius (m)</label>
                                        {{ form.radius }}
                                        {% if form.radius.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.radius.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">{{ form.radius.help_text }}</div>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <div id="map" style="height: 300px; border-radius: 0.25rem; display: none;"></div>
                                    <button type="button" class="btn btn-outline-secondary mt-2" id="showMap">
                                        <i class="fas fa-map-marker-alt me-1"></i> Pick Location on Map
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Timing and Notification Section -->
                            <div class="col-12 mb-4">
                                <h5 class="border-bottom pb-2 mb-3">Timing & Notifications</h5>
                                
                                <div class="mb-4">
                                    <label for="{{ form.expires_at.id_for_label }}" class="form-label">Expiry Date & Time</label>
                                    {{ form.expires_at }}
                                    {% if form.expires_at.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.expires_at.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">{{ form.expires_at.help_text }}</div>
                                </div>
                                
                                <div class="notification-options mb-3">
                                    <label class="form-label">Notification Methods</label>
                                    
                                    <div class="form-check">
                                        {{ form.send_email }}
                                        <label class="form-check-label" for="{{ form.send_email.id_for_label }}">
                                            Send email notifications
                                        </label>
                                        <div class="form-text">{{ form.send_email.help_text }}</div>
                                    </div>
                                    
                                    <div class="form-check">
                                        {{ form.send_sms }}
                                        <label class="form-check-label" for="{{ form.send_sms.id_for_label }}">
                                            Send SMS notifications
                                        </label>
                                        <div class="form-text">{{ form.send_sms.help_text }}</div>
                                    </div>
                                    
                                    <div class="form-check">
                                        {{ form.send_push }}
                                        <label class="form-check-label" for="{{ form.send_push.id_for_label }}">
                                            Send push notifications
                                        </label>
                                        <div class="form-text">{{ form.send_push.help_text }}</div>
                                    </div>
                                </div>
                                
                                <div class="send-options mt-4 p-3 bg-light rounded">
                                    <div class="form-check">
                                        {{ form.send_now }}
                                        <label class="form-check-label" for="{{ form.send_now.id_for_label }}">
                                            <strong>{{ form.send_now.label }}</strong>
                                        </label>
                                    </div>
                                    <div class="form-text">{{ form.send_now.help_text }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'community_alerts:alert_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i> Cancel
                            </a>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> {{ button_text }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Map Picker Script - Add proper Google Maps API key in production -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const mapDiv = document.getElementById('map');
        const showMapBtn = document.getElementById('showMap');
        const latInput = document.getElementById('{{ form.latitude.id_for_label }}');
        const lngInput = document.getElementById('{{ form.longitude.id_for_label }}');
        
        // Initialize map with default coordinates if not set
        let lat = latInput.value ? parseFloat(latInput.value) : -25.7519;
        let lng = lngInput.value ? parseFloat(lngInput.value) : 29.4522;
        
        let map, marker;
        
        // Show map when button is clicked
        showMapBtn.addEventListener('click', function() {
            if (mapDiv.style.display === 'none') {
                mapDiv.style.display = 'block';
                showMapBtn.innerHTML = '<i class="fas fa-times me-1"></i> Hide Map';
                
                // Initialize map if it doesn't exist
                if (!map) {
                    loadMapScript();
                }
            } else {
                mapDiv.style.display = 'none';
                showMapBtn.innerHTML = '<i class="fas fa-map-marker-alt me-1"></i> Pick Location on Map';
            }
        });
        
        // Load Google Maps script dynamically
        function loadMapScript() {
            if (typeof google === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap';
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);
            } else {
                initMap();
            }
        }
        
        // Initialize map
        window.initMap = function() {
            const mapOptions = {
                center: { lat: lat, lng: lng },
                zoom: 14,
                mapTypeControl: true
            };
            
            map = new google.maps.Map(mapDiv, mapOptions);
            
            // Add marker at current position
            marker = new google.maps.Marker({
                position: { lat: lat, lng: lng },
                map: map,
                draggable: true,
                title: 'Alert Location'
            });
            
            // Update coordinates when marker is dragged
            google.maps.event.addListener(marker, 'dragend', function(event) {
                latInput.value = event.latLng.lat().toFixed(6);
                lngInput.value = event.latLng.lng().toFixed(6);
            });
            
            // Update marker position when clicking on map
            google.maps.event.addListener(map, 'click', function(event) {
                marker.setPosition(event.latLng);
                latInput.value = event.latLng.lat().toFixed(6);
                lngInput.value = event.latLng.lng().toFixed(6);
            });
        };
        
        // Update map when coordinates are changed manually
        latInput.addEventListener('change', updateMarkerPosition);
        lngInput.addEventListener('change', updateMarkerPosition);
        
        function updateMarkerPosition() {
            if (latInput.value && lngInput.value && map && marker) {
                const newLat = parseFloat(latInput.value);
                const newLng = parseFloat(lngInput.value);
                
                if (!isNaN(newLat) && !isNaN(newLng)) {
                    const newPos = { lat: newLat, lng: newLng };
                    marker.setPosition(newPos);
                    map.setCenter(newPos);
                }
            }
        }
    });
</script>
{% endblock %}
