{% extends 'base.html' %}
{% block title %}Crime Map - Kingsapark Community{% endblock %}

{% block content %}
<div class="container py-4">
    <h2 class="text-center mb-3">Interactive Crime Map</h2>
    <p class="text-center text-muted mb-4">Visualize crime locations within Kingsapark Community.</p>

    <div id="crime-map" style="height: 600px; width: 100%;" class="rounded shadow-sm"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the map
        const map = L.map('crime-map').setView([-25.405, 30.988], 13); // Centered roughly on Mpumalanga, adjust as needed for Kingsapark

        // Add a tile layer (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Fetch crime data and add markers
        async function fetchCrimeData() {
            const headers = {'X-CSRFToken': getCookie('csrftoken')};
            const response = await fetch('{% url 'reports:crime_map_data' %}', {headers});
            const crimeReports = await response.json();

            crimeReports.forEach(report => {
                if (report.latitude && report.longitude) {
                    const marker = L.marker([report.latitude, report.longitude]).addTo(map);
                    marker.bindPopup(`
                        <b>${report.title}</b><br>
                        <b>Category:</b> ${report.category_display}<br>
                        <b>Status:</b> ${report.status_display}<br>
                        <b>Location:</b> ${report.location}<br>
                        <b>Date:</b> ${report.date_reported}
                    `);
                }
            });
        }

        // Helper function to get CSRF token (copied from analytics_dashboard.html)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        fetchCrimeData();
    });
</script>
{% endblock %}
